<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Game</title>
    <link rel="stylesheet" href="/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container game-container">
        <h1>Math Game</h1>
        <h2 id="question">Loading...</h2>
        <form id="answer-form">
            <input type="number" id="answer" placeholder="Your answer" required>
            <button type="submit">Submit</button>
        </form>
        <p id="message" class="message"></p>
        <button id="logout-button" class="logout">Logout</button>
    </div>

    <script>
        const questionEl = document.getElementById('question');
        const answerForm = document.getElementById('answer-form');
        const answerInput = document.getElementById('answer');
        const messageEl = document.getElementById('message');
        const logoutButton = document.getElementById('logout-button');

        let correctAnswer = null;
        let authToken = null;

        // --- Authentication Check ---
        function checkAuth() {
            authToken = localStorage.getItem('math_game_token');
            if (!authToken) {
                // If no token, redirect to login page
                window.location.href = '/';
            }
        }

        // --- API Fetch Helper ---
        // A wrapper for fetch that automatically adds our Auth token
        async function fetchAuthed(url, options = {}) {
            const headers = {
                ...options.headers, // Spread any existing headers
                'Authorization': `Bearer ${authToken}`
            };

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401) {
                // Our token is bad! Clear it and force a re-login.
                localStorage.removeItem('math_game_token');
                window.location.href = '/';
            }
            
            return response;
        }

        // --- Game Logic ---
        async function getNewQuestion() {
            try {
                const response = await fetchAuthed('/api/question');
                const data = await response.json();
                
                if (response.ok) {
                    questionEl.textContent = data.question;
                    correctAnswer = data.answer; // Store the correct answer
                    messageEl.textContent = '';
                    answerInput.value = '';
                    answerInput.focus();
                } else {
                    messageEl.textContent = data.error || 'Could not fetch question.';
                    messageEl.className = 'message error';
                }
            } catch (err) {
                messageEl.textContent = 'A network error occurred.';
                messageEl.className = 'message error';
            }
        }

        answerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userAnswer = parseInt(answerInput.value, 10);

            try {
                const response = await fetchAuthed('/api/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_answer: userAnswer,
                        correct_answer: correctAnswer // Send both to the server
                    })
                });

                const data = await response.json();

                if (data.correct) {
                    messageEl.textContent = 'Correct! Next question...';
                    messageEl.className = 'message success';
                    // Load a new question after a short delay
                    setTimeout(getNewQuestion, 1000);
                } else {
                    messageEl.textContent = 'Incorrect. Try again!';
                    messageEl.className = 'message error';
                }
            } catch (err) {
                messageEl.textContent = 'A network error occurred.';
                messageEl.className = 'message error';
            }
        });

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('math_game_token');
            window.location.href = '/';
        });

        // --- Initial Load ---
        checkAuth(); // Check for token first
        getNewQuestion(); // Then get the first question
    </script>
</body>
</html>

