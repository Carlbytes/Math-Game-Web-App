pipeline {
    agent {
        docker {
            image 'gcc:latest'
            // Maps the Docker socket so the container can talk to the daemon if needed
            args '-v /var/run/docker.sock:/var/run/docker.sock'
        }
    }

    environment {
        VCPKG_ROOT = "${WORKSPACE}/vcpkg"
        BUILD_DIR = "${WORKSPACE}/build"
        // Force vcpkg to run as root inside the container
        VCPKG_FORCE_SYSTEM_BINARIES = '1'
    }

    stages {
        stage('Setup Environment') {
            steps {
                script {
                    // Install dependencies inside the Docker container
                    sh 'apt-get update && apt-get install -y git curl zip unzip tar cmake ninja-build pkg-config'
                }
            }
        }

        stage('Install Dependencies (vcpkg)') {
            steps {
                script {
                    if (!fileExists("${VCPKG_ROOT}/vcpkg")) {
                        sh 'git clone https://github.com/microsoft/vcpkg.git ${VCPKG_ROOT}'
                        sh '${VCPKG_ROOT}/bootstrap-vcpkg.sh'
                    }
                    sh '${VCPKG_ROOT}/vcpkg install'
                }
            }
        }

        stage('Configure (CMake)') {
            steps {
                sh """
                    cmake -B ${BUILD_DIR} -S . \
                    -DCMAKE_TOOLCHAIN_FILE=${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake \
                    -DCMAKE_BUILD_TYPE=Debug
                """
            }
        }

        stage('Build') {
            steps {
                sh "cmake --build ${BUILD_DIR}"
            }
        }

        stage('Unit Tests') {
            steps {
                dir("${BUILD_DIR}") {
                    // Run the tests and produce JUnit XML output
                    sh './RunTests -r junit -o results.xml'
                }
            }
            post {
                always {
                    // Publish the test results to Jenkins
                    junit "${BUILD_DIR}/results.xml"
                }
            }
        }

        stage('Dry Run (Verification)') {
            steps {
                dir("${BUILD_DIR}") {
                    script {
                        // Start the game server in background
                        sh 'nohup ./MathGame > server.log 2>&1 &'
                        sleep 5
                        // Check if it responds to a request
                        sh 'curl -v --fail http://localhost:18080/'
                        // Clean up
                        sh 'pkill MathGame || true'
                    }
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}